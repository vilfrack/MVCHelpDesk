@model IEnumerable<MVCHelpDesk.ViewModel.ViewPermisos>
    <h1>Usuarios creados</h1>

<form class="form-horizontal" id="frmPermisos">
    <table id="tablePermisos" class="table table-striped table-bordered" cellspacing="0">
        @foreach (var varModulo in Model.Select(s => new { s.ModuloID, s.ModuloDescripcion }).Distinct().ToList())
            {
            <thead style="background-color:#E0F2F1">
                <tr>
                    <th>@varModulo.ModuloID</th>
                    <th>@varModulo.ModuloDescripcion</th>
                    <th>Rol</th>
                    <th>Usuario</th>
                </tr>
            </thead>
                <tbody>
                    @foreach (var itemModel in Model.Where(w => w.ModuloID == varModulo.ModuloID).Select(s => new { s.PermisoID, s.PermisoDescripcion, s.CheekRol, s.CheekUsuarios }).Distinct().ToList())
                    {
                        <tr>
                            <td>
                                <label style="padding-left:20px;">@itemModel.PermisoID</label>
                            </td>
                            <td>
                                <label style="padding-left:20px;"> @itemModel.PermisoDescripcion</label>
                            </td>
                            <td>
                                @Html.CheckBox("CheekRol", itemModel.CheekRol, new { data_permiso = itemModel.PermisoID, data_modulo = varModulo.ModuloID })
                            </td>
                            <td>
                                @Html.CheckBox("CheekUsuario", itemModel.CheekUsuarios, new { data_permiso = itemModel.PermisoID, data_modulo = varModulo.ModuloID })
                            </td>
                        </tr>
                    }
                </tbody>
        }
    </table>
    <button type="submit" id="btnSave" class="btn btn-primary btn-group-lg"><i class="fa fa-save"></i> Guardar</button>
</form>

    <script>
        var permissionObject = [];
        $("input[name='CheekRol']").on('click', function () {
            var permiso = $(this).data("permiso");
            var modulo = $(this).data("modulo");

            if ($(this).is(':checked')) {
                permissionObject.push({
                    permisoID: permiso,
                    moduloID: modulo,
                    IDUsuario: "USUARIO",
                    IDRol: "ROL"
                });
            } else {
                // findIndex NOS PERMITE BUSCAR EL INDICE DEL OBJETO, PASANDOLE LOS VALORES A BUSCAR
                index = permissionObject.findIndex(x => x.permisoID == permiso && x.moduloID == modulo);
                if (index != -1) {
                    //.splice PERMITE BORRAR EL INDICE DEL OBJETO
                    permissionObject.splice(index, 1);
                }
            }
        });
        $("input[name='CheekUsuario']").on('click', function () {
            var permiso = $(this).data("permiso");
            var modulo = $(this).data("modulo");

            if ($(this).is(':checked')) {
                permissionObject.push({
                    UsuarioPermisoID: permiso,
                    UsuarioModuloID: modulo,
                    IDUsuario: "USUARIO",
                    IDRol: "ROL"
                });
            } else {
                // findIndex NOS PERMITE BUSCAR EL INDICE DEL OBJETO, PASANDOLE LOS VALORES A BUSCAR
                index = permissionObject.findIndex(x => x.UsuarioPermisoID == permiso && x.UsuarioModuloID == modulo);
                if (index != -1) {
                    //.splice PERMITE BORRAR EL INDICE DEL OBJETO
                    permissionObject.splice(index, 1);
                }
            }
        });
        $("#frmPermisos").submit(function (e) {
            var myParam = permissionObject;

            myParam = JSON.stringify({ 'list': myParam });
           // myParam = JSON.stringify({ 'list': hola });
            $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: '/Permisos/Details',
                data: myParam,

                success: function (data) {

                    if (data.success) {
                        //REESTABLECE LOS ESTILOS PREDEFINIDOS DE LOS LABEL ERRORES Y DIV, EN CASO DE QUE SE HAYAN MOSTRADO Y SE HAYAN CORREGIDO
                        $.each(parametros, function (key, value) {
                            $("#ErrorEdit_" + key).html('');
                            $("#divEdit_" + key).removeClass(" has-error has-feedback");
                        });
                        $('#alert_success').show("fast");
                        $('#alert_success').show("fast");
                        $('#alert_danger').hide();
                        LoadGridDepartamento();

                    }
                    else {
                        //VA A CAPTURAR TODOS LOS ERRORES ENVIADOS DEL CONTROLADOR
                        $.each(data.Errors, function (key, value) {
                            //VALUE VA A TRAER SOLO AQUELLOS VALORES QUE NO CUMPLAN CON LOS REQUISITOS ESTABLECIDOS EN EL MODELSTATE
                            //CREAR EN LO POSIBLE UNA CLASE QUE GUARDE ESTE CODIGO
                            if (value != "true") {
                                $("#ErrorEdit_" + key).html(value[value.length - 1].ErrorMessage);
                                $("#divEdit_" + key).addClass(" has-error has-feedback");
                            } else {
                                $("#ErrorEdit_" + key).html('');
                                $("#divEdit_" + key).removeClass(" has-error has-feedback");
                            }

                        });
                    }
                },
                error: function (data) {
                    $('#alert_danger').html(data);
                    $('#alert_danger').show("fast");
                },

            });
        });
    </script>
